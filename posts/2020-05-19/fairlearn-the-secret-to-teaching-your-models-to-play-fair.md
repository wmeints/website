---
title: "Fairlearn: The secret to teaching your models to play fair"
category: Machine Learning
datePublished: "2020-05-19"
dateCreated: "2020-05-14"
---

<p>Microsoft just announced a new suite of tools around Responsible AI during the Microsoft Build conference. One of the tools that they announced is fairlearn. A new python package that will help you build fair models. In this article I’m going to show you that fairlearn is the secret sauce to building fair models.</p><p>In this article, we’ll cover the following topics:</p><ul><li>What is fairlearn, and why should I care?</li><li>How do I check if my model is fair using fairlearn?</li><li>How can I improve an unfair model using fairlearn?</li></ul><p>Let’s get started by exploring what fairlearn is and why it’s an exciting tool to use for machine learning engineers and data scientists.</p><h1 id="what-is-fairlearn-and-why-should-i-care">What is fairlearn, and why should I care?</h1><p>Fairlearn is a new Python package developed by Microsoft. It implements several algorithms to detect and mitigate group fairness issues in machine learning models. Before we dive into what fairlearn offers, let’s first try to understand what model fairness means.</p><h2 id="why-is-being-fair-important">Why is being fair important?</h2><p>When we train machine learning models, we want them to behave fairly. But despite our best efforts, we may harm people. There's two ways in which we can talk about fairness: Fairness towards an individual, and fairness towards groups of people. Fairlearn aims to fix group fairness issues.</p><p>There’s a couple of ways in which a machine learning model could harm groups of people that fairlearn aims to solve:</p><ul><li>First, there’s the allocation harm: Denying access to products, services, or information for groups of people</li><li>Second, there’s the quality of service harm: A group of people gets a lower quality service, product, or information. Even though they have access to the product, service, or information source.</li></ul><p>Both problems are bad for business. For example, denying a credit card loan to a customer based on gender, ethnic background, or the location of the customer harms the customer and is illegal. There’s not going to be a lot of discussion about that. Now imagine, the same customer gets a credit card loan, but the machine learning model decides that the person should get a higher interest rate on their credit card loan than someone else. The person still gets a credit card, but we’re providing a lower quality of service. The higher interest rate looks good but it’s unfair to the customer.</p><p>A model that discriminates is forbidden by law. But we can’t really see that with the naked eye because of the complexity of machine learning models and the associated datasets.</p><p>And even if we don’t break the law, an unfair model is just bad for business. We’ll sooner or later lose customers because we’re using an unfair model.</p><h2 id="how-does-fairlearn-help">How does fairlearn help?</h2><p>Fairlearn offers a couple of tools that help you detect and mitigate unfairness in your models. There are two main features in the <code>fairlearn</code> package:</p><ul><li><strong>Assessing fairness:</strong> Fairlearn contains a <code>FairlearnDashboard</code> component and a set of metrics that help you measure the fairness of your model. </li><li><strong>Mitigating unfairness:</strong> Alongside the metrics, and dashboard, there's a set of algorithms in <code>fairlearn</code> to help mitigate unfair behavior in models. You can, for example, use a postprocessing algorithm to improve existing models. But there are also a couple of algorithms that help you improve the model during training.</li></ul><p>Let’s look at a couple of the components in the fairlearn package to discover how they help you detect and mitigate unfair behavior.</p><h2 id="how-do-i-use-fairlearn-to-validate-my-model">How do I use fairlearn to validate my model?</h2><p>To understand how fair your model is, we need some way to measure fairness and visualize the results. This is where the fair learning dashboard comes in.</p><p>As an example, we're going to look at a model that predicts whether a customer is going to default their next credit card payment. The model is trained using historical data and some general properties of the customer. </p><p>The output of the model is <code>1</code> in case someone is likely to default their next credit card payment. The output is <code>0</code> in case someone is likely to pay on time.</p><p>We can use this model to score a credit card application. If the model predicts <code>0</code> we grand the customer a credit card; Otherwise we deny the credit card application.</p><p>Now, let's take a look at how this model behaves when we assess its fairness.</p><p>The fairlearn package contains a component called FairlearnDashboard. It’s a widget that we can use within a Python notebook which measures and visualizes two metrics for our model:</p><ul><li>Metric disparity: a measure that we can use to see what the difference in performance is between different groups of users for our model.</li><li>Prediction disparity: a measure that shows the difference of true positives between groups for binary classification models. For regression models it shows the difference in distribution of predicted outputs for different groups.</li></ul><p>To use the fair learning dashboard, we need to write a few lines of Python.</p><pre><code>FairlearnDashboard(
    sensitive_features=df_test['SEX'],
    sensitive_feature_names=['Gender'],
    y_true=y_test,
    y_pred=classifier.predict(x_test))</code></pre><p>This code performs the following steps:</p><ul><li>First, we collect a set of predictions using a test dataset.</li><li>Next, we collect a set of sensitive features, these identify the groups of users.</li><li>Then, we collect the names for the sensitive features.</li><li>Finally, we call the <code>FairlearnDashboard</code> constructor and feed it the data we collected.</li></ul><p>The output of the code can be seen in the picture below.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2020/05/fairlearn-dashboard-step-1.png" class="kg-image"><figcaption>Initial screen you'll get when creating a new FairlearnDashboard.</figcaption></figure><p>After executing the code, we’ll get a dashboard allowing us to select a sensitive feature that we want to explore. </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2020/05/fairlearn-dashboard-step-2.png" class="kg-image"><figcaption>Selecting a sensitive feature to evaluate.</figcaption></figure><p>Once we’ve selected a sensitive feature and clicked next, we can choose a metric to explore for the sensitive feature.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2020/05/fairlearn-dashboard-step-3.png" class="kg-image"><figcaption>Selecting a metric to measure performance.</figcaption></figure><p>Finally, when we click next again, we get a dashboard that shows the results.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2020/05/fairlearn-dashboard-step-4a.png" class="kg-image"><figcaption>The dashboard containing the results.</figcaption></figure><p>The top half of the dashboard shows the performance disparity. From the chart you'll notice that the performance of the model is worse for male users. </p><p>There's another interesting detail that we have to look at. Check out the under prediction for female customers (The orange bar for the value 2). </p><p>When we were to use this model, it would be more likely for a female customer to get a credit card. And this isn't so much based on their income or past behavior. It's because of a gender bias in our model.</p><p>Now let's take a look at the bottom half of the dashboard.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2020/05/fairlearn-dashboard-step-4b.png" class="kg-image"><figcaption>The bottom half of the dashboard.</figcaption></figure><p>When we look at the bottom half of the dashboard, we can see the prediction disparity. In the case of the image above, it shows that there’s quite a large difference for male and female customers. It's far more likely for a male customer to get denied a credit card, because the model predicts that the customer is going to default their next payment.</p><p>From the dashboard we can conclude that the model is doing worse for male customers than for female customers. </p><p>But how are we going to fix that? Let’s look at some options for fixing your model.</p><h1 id="how-can-i-use-fairlearn-to-improve-an-unfair-model">How can I use fairlearn to improve an unfair model?</h1><p>The fairlearn package contains several algorithms that help solve unfairness in models without changing the data that we used to train the model.</p><p>There are two strategies that we can apply to solve unfairness with fairlearn:</p><ul><li>For existing models, we can mitigate unfairness using postprocessing.</li><li>For new models, we can use reduction algorithms to improve fairness.</li></ul><p>For this post we're going  to focus on using post-processing to improve an existing model.</p><h2 id="using-the-thresholdoptimizer-algorithm-to-improve-an-existing-model">Using the ThresholdOptimizer algorithm to improve an existing model</h2><p>When we have a trained model, we can use a postprocessing component called the ThresholdOptimizer to equalize the odds between different groups of users of our model. In a sense, we’re giving each group an equal playing field, so the outcome of the model no longer depends on sensitive attributes like age, ethnicity, etc.</p><p>The TresholdOptimizer is based on a paper called “Equality of Opportunity in Supervised learning”. It tries to correct the model so that it no longer discriminates against specific groups of users, based on a set of sensitive features.</p><p>To use the TresholdOptimizer, we need to have one or more features in our data that we identify as sensitive. For example, this could be age, gender, ethnicity, or similar.</p><p>Let’s apply the TresholdOptimizer to an existing model:</p><figure class="kg-card kg-code-card"><pre><code class="language-python">optimizer = ThresholdOptimizer(
    estimator=classifier, 
    constraints='demographic_parity')
    
optimizer.fit(x_train, y_train, sensitive_features=df_train['gender'])</code></pre><figcaption>Training the TresholdOptimizer.</figcaption></figure><p>This code performs the following steps:</p><ul><li>First, we create the TresholdOptimizer for the model.</li><li>Then, we train the optimizer using the original training dataset including the sensitive features for the training dataset. We’ll be using ‘equalized_odds’ as the constraint.</li></ul><p>After we’ve trained the optimizer, we can use it instead of the normal model to make predictions. It has the same interface as a regular scikit-learn model meaning, we can call predict and transform on it to make predictions:</p><figure class="kg-card kg-code-card"><pre><code class="language-python">optimizer.predict(x_test, y_test, sensitive_features=df_test['gender'])</code></pre><figcaption>Making a prediction using the TresholdOptimizer.</figcaption></figure><p>Note, that we’ve used a <code>scikit-learn</code> model as the input for the <code>ThresholdOptimizer</code>. The algorithm used by the <code>TresholdOptimizer</code> is a blackbox solution. This means that we can apply it to several types of models. Right now, binary classification models and regression models are supported. If they have a fit and predict method.</p><p>Deep learning-based models often aren’t based on the estimator structure that <code>scikit-learn</code> has. You can still use the <code>TresholdOptimizer</code> by wrapping your deep learning model in a class that derives from <code>sklearn.base.BaseEstimator</code>.</p><p>The <code>TresholdOptimizer</code> is not a magic component that will fix all our problems. It will only reduce the fairness problems in our model. Sometimes not by a lot and sometimes it does help a great deal.</p><h1 id="conclusion">Conclusion</h1><p>In this post we've talked about several techniques that <code>fairlearn</code> provides for improving your model's fairness. We've looked at:</p><ul><li>Measuring fairness using the fairlearn dahboard widget.</li><li>Improving fairness for trained models using <code>TresholdOptimizer</code></li><li>Training models with improved fairness using <code>GridSearch</code></li></ul><p>If you're interested in the code, it's up on Github: <a href="https://github.com/wmeints/fairlearn-demo">https://github.com/wmeints/fairlearn-demo</a></p><p>You can find more information about fairlearn here: </p><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://github.com/fairlearn/fairlearn"><div class="kg-bookmark-content"><div class="kg-bookmark-title">fairlearn/fairlearn</div><div class="kg-bookmark-description">A Python package that implements a variety of algorithms that mitigate unfairness in supervised machine learning. - fairlearn/fairlearn</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://github.githubassets.com/favicons/favicon.svg"><span class="kg-bookmark-author">fairlearn</span><span class="kg-bookmark-publisher">GitHub</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://avatars0.githubusercontent.com/u/54074260?s=400&amp;v=4"></div></a></figure><p>Please leave a note on my twitter account (@willem_meints) if you have any questions!</p>
