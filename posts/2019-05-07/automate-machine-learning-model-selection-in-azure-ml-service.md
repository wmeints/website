---
title: Automate machine learning model selection in Azure Machine Learning Service
category: Machine Learning
datePublished: '2019-05-07'
dateCreated: '2019-05-06'
---
<p>Trying to come up with a good model for a machine learning solution can be quite tedious. You'll need to first come up with the right data, then there's the preprocessing and if that's not enough, you need to try multiple models to find one that works best for your problem. There must be a better way right?</p><p>In this post I'll show you how you can use a new feature in Azure Machine Learning Service to help find the right model to solve your machine learning problem without writing any code.</p><p>We'll cover the following topics in this post:</p><ul><li>How Automated ML works</li><li>Setting up an experiment with Automated ML</li><li>Deploying a model trained with Automated ML</li></ul><p>Let's get started by looking at how Automated ML works to help you speed up the process of building a machine learning model.</p><h2 id="how-automated-ml-works">How Automated ML works</h2><p>At the core of Automated ML is a process that performs a number of steps for you:</p><ol><li>First, a number of features is selected for training</li><li>Then, a model is trained and evaluated on a key metric</li></ol><p>This is what you'd expect from the process of training and evaluating a machine learning model. </p><p>What makes Automated ML special is that it uses an intelligent algorithm to try several combinations of features, pre-processing steps, and algorithms to train a bunch of models. After trying out several models it will then select the best model based on the key metric and return that as the result.</p><p>All you need to do is:</p><ul><li>Define the kind of problem to solve</li><li>Provide a dataset to use for training</li><li>Select what metric to use for selecting the best model</li><li>Configure how much time to spend on the selection process</li></ul><p>In the past, you could already set up an Automated ML experiment from code. But Microsoft made things easier by providing a clean user interface as part of Azure Machine Learning Service so you can run Automated ML experiments without writing any code.</p><h2 id="setting-up-an-experiment-with-automated-ml">Setting up an experiment with Automated ML</h2><p>Let's take a look at how to set up an Automated ML experiment in Azure Machine Learning Service. You'll need to have an Azure Machine Learning Workspace set up for this. There's <a href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-manage-workspace">a good tutorial in the documentation</a> to get you going.</p><p>When you've created a workspace you'll be able to find in the portal by navigating to the resource group that you've created and then selecting the workspace. When you select the workspace you'll see a layout similar to this:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/MLWorkspace.PNG" class="kg-image"><figcaption>Azure Machine Learning Workspace</figcaption></figure><p>In the machine learning workspace, navigate to the Automated Machine Learning dashboard in the menu on the left. You'll get an overview of all the Automated ML experiments in your workspace.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/AutomatedML.PNG" class="kg-image"><figcaption>Automated ML experiments dashboard</figcaption></figure><p>To create a new experiment, click the <em>Create Experiment</em> button at the top of the page. You'll get a new screen that looks like the image below.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/CreateExperiment.PNG" class="kg-image"><figcaption>Create a new experiment</figcaption></figure><p>In this window you can enter the name for the experiment and select a compute target to run the experiment on. If you haven't got a VM yet, you can create a new one right from this screen using the <em>Create a new compute</em> button.</p><p>The compute target that you create here is a linux VM of a size that you can choose. It will run the docker image that contains the Automated ML code. Depending on the size of your dataset and the number of models to try, it will take a long time on smaller VMs, so I suggest you pick a decent size VM for your experiment.</p><p>After you've created or selected the training compute target, click the <em>Next</em> button to move to the next step. </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/SelectStorage.PNG" class="kg-image"><figcaption>Select an input file from an Azure Blob Storage Account</figcaption></figure><p>In the next step, we'll select the data source for the Automated ML experiment. Currently, only Azure Blob Storage is supported. If you happen to have data in SQL Server or Cosmos DB you'll have to export it to CSV first. </p><p>You can either select an existing file from this step or upload a new file to the storage account. </p><p>Select the file you want to run the experiment. You'll now see the details of the input file and be able to select the columns for your experiment.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ConfigureDataSource.PNG" class="kg-image"><figcaption>Configure the data source for your experiment</figcaption></figure><p>Include or exclude any columns for the experiment by clicking the toggle button above the column. Next, select the kind of problem you're trying to solve. Then, select the target column from the dropdown. </p><p>At this point you're good to go with the experiment. If you want, you can configure more advanced settings by expanding the <em>Advanced Settings</em> panel.</p><p>Click <em>Start</em> to run the experiment on your compute target. Please note that it will take a while to set everything up. In my case it took about 10 minutes to prepare the experiment and another 40 minutes to train all possible combinations of models.</p><p>Once your experiment is running you can see the output in the dashboard. It will look similar to this screenshot:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ExperimentDetails.PNG" class="kg-image"><figcaption>Experiment details</figcaption></figure><p>In the middle of the page you'll see a chart displaying how each experiment is doing based on a key metric. Below the chart you can see a list of models and pre-processing combinations that are tested in the experiment. On the right, you can find the settings for the experiment.</p><p>When you select a model from the list of models at the bottom of the screen you'll be presented with the details for that particular model:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/RunDetails.PNG" class="kg-image"><figcaption>The details for a single model</figcaption></figure><p>In this screen you can explore different metrics that were collected for the model. For example, you can check out the precision/recall curves and F1-scores for classification models. </p><p>Once the experiment is completed and you're happy with the results you can deploy the best model to production, let's take a look at that next.</p><h2 id="deploying-a-model-trained-with-automated-ml">Deploying a model trained with Automated ML</h2><p>Currently, there's no automated way of deploying the model obtained through an Automated ML experiment in the portal. This is something that I expect will change as the preview of this feature progresses.</p><h3 id="registering-the-trained-model">Registering the trained model</h3><p>To deploy a model trained using Automated ML, you'll have to download it. From the Automated ML experiment details screen, click the <em>download</em> button to the right of the model that you want to deploy.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ExperimentDetails-1.PNG" class="kg-image"><figcaption>Experiment details</figcaption></figure><p>By clicking the <em>download</em> button you'll get a <em>model.pkl</em> file that contains the scikit-learn pipeline for the trained model.</p><p>In order to use the model, we'll need to register it in the model registry. Navigate to the <em>Models</em> section of the Azure Machine Learning Workspace. You'll see a screen similar to this:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/UploadModel.PNG" class="kg-image"><figcaption>Models overview</figcaption></figure><p>In this screen, click the <em>Add model</em> button. This will take you to the next screen:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ModelDetails.PNG" class="kg-image"><figcaption>Model details</figcaption></figure><p>In this screen, provide a name for the model and select the <em>model.pkl</em> file that you downloaded earlier. Click the <em>Create</em> button to store the model in the model registry.</p><p>Once the model is uploaded, you'll be taken to the model details screen which displays the details of the model. </p><p>Now that you have a model, let's create a script to use the model. We'll need to perform a couple of steps to use the model:</p><ol><li>First, we'll need a scoring script for the model</li><li>Next, we'll need an environment file that describes the used libraries</li><li>Finally, we need to create an image for the model on the portal.</li></ol><h3 id="creating-the-scoring-script">Creating the scoring script</h3><p>Let's start with the scoring script. Create a new file, <em>score.py</em> with the following contents:</p><pre><code>import json
import numpy as np
from sklearn.externals import joblib
from sklearn.linear_model import Ridge
from azureml.core.model import Model

from inference_schema.schema_decorators import input_schema, output_schema
from inference_schema.parameter_types.numpy_parameter_type import NumpyParameterType

def init():
    global model
    
    model_path = Model.get_model_path('CategorizeTransactions')
    model = joblib.load(model_path)

input_sample = np.array([['sample text']])
output_sample = np.array(['label'])

@input_schema('data', NumpyParameterType(input_sample))
@output_schema(NumpyParameterType(output_sample))
def run(data):
    try:
        result = model.predict(data)
        return result.tolist()
    except Exception as e:
        error = str(e)
        return error</code></pre><p>The scoring script should contain two functions: init, and run. The init function is invoked when the application is started. The run function is used to make predictions with the model.</p><p>In the init function we retrieve the model from the model registry by the name that we choose earlier. After that, we load the model using the <code>joblib.load</code> function.</p><p>In the run function we get in a sample of data from the client stored as a numpy array. We run the sample through the model's <code>predict</code> method to get a prediction. We then return the generated output to the client.</p><p>It's important to note that the output should be JSON serializable. You don't have to serialize the data yourself, the runtime will take care of this process automatically.</p><p>Now that we have a scoring script, let's set up the environment dependencies for the model.</p><h3 id="creating-the-environment-requirements-file">Creating the environment requirements file</h3><p>In order to run the scoring script, Azure ML needs to know about the libraries that you're using in the scoring script. In the case of Automated ML there are a few standard dependencies that you'll need. </p><p>The environment requirements are stored in a <code>conda_env.yaml</code> file with the following contents:</p><pre><code>name: project_environment
dependencies:
  - python=3.6.2
  - pip:
    - azureml-defaults
    - scikit-learn
    - inference-schema[numpy-support]</code></pre><p>The anaconda environment file is used to set up an anaconda environment inside the docker container that will host the model. It contains a specification for all the used python packages.</p><p>Once you have the environment file, it's time to deploy the model as an image in the Azure Machine Learning Workspace.</p><h3 id="deploy-the-model-as-an-image">Deploy the model as an image</h3><p>You can deploy a model as an image by clicking the <em>Create image</em> button at the top of the screen when you're looking at the model details in the Azure Machine Learning Workspace.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ModelDetails2.PNG" class="kg-image"><figcaption>Model details</figcaption></figure><p>When you click the <em>Create image</em> button you'll get presented with a new screen that allows you to upload the scoring script and environment file.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/CreateImage.PNG" class="kg-image"><figcaption>Create an image for the model</figcaption></figure><p>In this screen, provide a name for the image and select the scoring script and environment file for the image. Finally, click the <em>Create</em> button to create the new image.</p><p>It will take a while for the image to be created. This is a great opportunity to grab a drink.</p><p>The next step is to deploy the image as a docker container into production. </p><h3 id="deploying-the-image">Deploying the image</h3><p>Once the image is created, you can deploy it in the cloud either on Kubernetes or as an Azure Container Instance. To do this, you'll need to create the <em>Create deployment</em> button from the image details screen.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/ImageDetails.PNG" class="kg-image"><figcaption>Image details</figcaption></figure><p>When you click the <em>Create deployment</em> button you'll be presented with the deployment screen.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/content/images/2019/05/CreateDeployment.PNG" class="kg-image"><figcaption>Create a new deployment</figcaption></figure><p>Give the deployment a name and select the type of deployment you want. The cheapest option is to use ACI (Azure Container Instance). Click the <em>Create</em> button to start deploying the model.</p><p>The process will take a few minutes to complete. After this you can use the model by making a HTTP request to the deployed container instance with the data you want to make a prediction for. </p><h2 id="summary">Summary</h2><p>In this post you learned how to use Automated ML with Azure Machine Learning service to train and deploy a model trained on your data. </p><p>The Automated ML features in the portal are in public preview and will change a few times before everything is final. But it sure is a great start and I'm looking forward to what the future holds!</p><p></p><p></p>
